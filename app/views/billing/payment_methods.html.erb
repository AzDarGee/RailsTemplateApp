
<div class="container py-4">
  <div class="row g-3">
    <div class="col-12 order-2">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Your Payment Methods</span>
        </div>
        <div class="card-body">
          <div id="payment_methods_list">
            <%= render partial: "billing/payment_methods_list", locals: { payment_methods: @payment_methods, current_default_id: @current_default_id } %>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 order-1">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Add a new card</span>
        </div>
        <div class="card-body">
          <% if current_user.payment_processor.processor.to_s == 'stripe' %>
            <% if @stripe_public_key.present? %>
              <% if @stripe_key_mismatch %>
                <div class="alert alert-warning small">Your Stripe publishable key and secret key appear to be from different modes (<%= @stripe_key_mode %> vs <%= @secret_key_mode %>). This can cause 400 errors when confirming cards. Update your credentials to match.</div>
              <% end %>

              <div id="payment_methods_meta">
                <%= render partial: "billing/payment_methods_meta", locals: { payment_methods_count: @payment_methods_count, app_max_payment_methods: @app_max_payment_methods, at_payment_method_cap: @at_payment_method_cap } %>
              </div>

              <div id="card-errors" class="text-danger small mb-2" role="alert"></div>
              <form id="add-card-form" action="<%= billing_attach_payment_method_path %>" method="post" data-at-cap="<%= @at_payment_method_cap ? '1' : '0' %>">
                <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                <input type="hidden" name="payment_method_id" id="payment_method_id" />

                <div class="mb-3">
                  <label class="form-label">Card details</label>
                  <div id="card-element" class="form-control p-2"></div>
                </div>

                <button id="add-card-button" class="btn btn-primary" type="submit" disabled data-loading-text="Loading…">Add Card</button>
              </form>

              <script src="https://js.stripe.com/v3/"></script>
              <script>
                (function() {
                  let stripe, elements, card, clientSecret, submitHandler;

                  function initStripeCardForm() {
                    const form = document.getElementById('add-card-form');
                    if (!form) return;

                    // Prevent double-initialization on repeated turbo:load events
                    if (form.dataset.stripeBound === '1') {
                      return;
                    }

                    const btn = document.getElementById('add-card-button');
                    const errorsEl = document.getElementById('card-errors');
                    const pmInput = document.getElementById('payment_method_id');

                    // Ensure initial state
                    const originalBtnText = btn.textContent;
                    const loadingText = btn.getAttribute('data-loading-text') || 'Loading…';
                    const atCap = (form.getAttribute('data-at-cap') === '1');
                    if (atCap) {
                      btn.disabled = true;
                      btn.textContent = originalBtnText;
                    } else {
                      btn.disabled = true;
                      btn.textContent = loadingText;
                    }

                    // Setup Stripe
                    try {
                      stripe = Stripe('<%= j @stripe_public_key %>');
                    } catch (e) {
                      errorsEl.textContent = 'Stripe failed to initialize.';
                      btn.disabled = false;
                      btn.textContent = originalBtnText;
                      return;
                    }

                    // Attach submit handler immediately to prevent accidental native POSTs
                    submitHandler = async function(e) {
                      e.preventDefault();
                      errorsEl.textContent = '';

                      // Prevent re-entrant submits
                      if (form.dataset.submitting === '1') { return; }
                      form.dataset.submitting = '1';

                      // Ensure the Element is still mounted before confirming
                      const cardContainer = document.getElementById('card-element');
                      if (!card) {
                        errorsEl.textContent = 'Card form is still loading. Please wait a moment and try again.';
                        delete form.dataset.submitting;
                        return;
                      }
                      if (!cardContainer || cardContainer.childElementCount === 0) {
                        try { card.mount('#card-element'); } catch (_) {}
                      }

                      btn.disabled = true;
                      btn.textContent = loadingText;

                      try {
                        const resp = await fetch('<%= billing_setup_intent_path %>', {
                          method: 'POST',
                          headers: {
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
                            'Accept': 'application/json'
                          }
                        });
                        const data = await resp.json();
                        if (!resp.ok || data.error) {
                          throw new Error(data.error || 'Failed to create SetupIntent.');
                        }

                        const { setupIntent, error } = await stripe.confirmCardSetup(data.client_secret, {
                          payment_method: {
                            card: card,
                            billing_details: {
                              email: '<%= j current_user.email %>'
                            }
                          }
                        });

                        if (error) {
                          throw error;
                        }

                        pmInput.value = setupIntent.payment_method;
                        // Use native submit to avoid re-triggering the submit handler
                        form.removeEventListener('submit', submitHandler);
                        form.submit();
                        return;
                      } catch (err) {
                        const msg = (err && err.message) ? err.message : 'Unable to confirm card setup.';
                        errorsEl.textContent = msg;
                        btn.disabled = false;
                        btn.textContent = originalBtnText;
                        delete form.dataset.submitting;
                      }
                    };

                    form.addEventListener('submit', submitHandler, { once: false });

                    // Mount Elements immediately; we'll create a SetupIntent just-in-time on submit
                    elements = stripe.elements();
                    card = elements.create('card');
                    card.mount('#card-element');

                    // Mark as initialized to avoid duplicate mounts/listeners
                    form.dataset.stripeBound = '1';

                    btn.disabled = false;
                    btn.textContent = originalBtnText;
                  }

                  function teardownStripeCardForm() {
                    const form = document.getElementById('add-card-form');
                    const btn = document.getElementById('add-card-button');
                    const errorsEl = document.getElementById('card-errors');

                    if (card) {
                      try { card.unmount(); } catch (_) {}
                    }
                    card = null;
                    elements = null;
                    clientSecret = null;

                    if (form && submitHandler) {
                      form.removeEventListener('submit', submitHandler);
                      delete form.dataset.stripeBound;
                    }
                    submitHandler = null;

                    if (btn) {
                      btn.disabled = false;
                    }
                    if (errorsEl) { errorsEl.textContent = ''; }
                  }

                  document.addEventListener('turbo:load', initStripeCardForm);
                  document.addEventListener('turbo:before-cache', teardownStripeCardForm);
                })();
              </script>

              <script>
                (function() {
                  let metaObserver;
                  function updateAddButtonFromMeta() {
                    const meta = document.getElementById('payment_methods_meta_data');
                    const form = document.getElementById('add-card-form');
                    const btn = document.getElementById('add-card-button');
                    if (!meta || !form || !btn) return;
                    const atCap = meta.getAttribute('data-at-cap') === '1';
                    form.setAttribute('data-at-cap', atCap ? '1' : '0');
                    const originalBtnText = btn.getAttribute('data-original-text') || btn.textContent;
                    if (!btn.getAttribute('data-original-text')) { btn.setAttribute('data-original-text', originalBtnText); }
                    const loadingText = btn.getAttribute('data-loading-text') || 'Loading…';
                    if (atCap) {
                      btn.disabled = true;
                      btn.textContent = originalBtnText;
                    } else {
                      // Enable button if not currently submitting; text stays original
                      if (!document.getElementById('add-card-form')?.dataset.submitting) {
                        btn.disabled = false;
                        btn.textContent = originalBtnText;
                      }
                    }
                  }
                  function startObserver() {
                    const metaContainer = document.getElementById('payment_methods_meta');
                    if (!metaContainer) return;
                    updateAddButtonFromMeta();
                    metaObserver = new MutationObserver(updateAddButtonFromMeta);
                    metaObserver.observe(metaContainer, { childList: true, subtree: true });
                  }
                  function stopObserver() {
                    if (metaObserver) { metaObserver.disconnect(); metaObserver = null; }
                  }
                  document.addEventListener('turbo:load', startObserver);
                  document.addEventListener('turbo:before-cache', stopObserver);
                })();
              </script>

              <script>
                (function() {
                  let pmListObserver, highlightTimer;
                  function highlightNewDefault() {
                    const list = document.getElementById('payment_methods_list');
                    if (!list) return;
                    const el = list.querySelector('li[data-defaulted="1"]');
                    if (!el) return;
                    el.classList.add('flash-highlight');
                    el.setAttribute('aria-live', 'polite');
                    try { el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } catch (_) {}
                    // prevent retrigger on subsequent DOM mutations
                    el.setAttribute('data-defaulted', '0');
                    if (highlightTimer) clearTimeout(highlightTimer);
                    highlightTimer = setTimeout(function() {
                      el.classList.remove('flash-highlight');
                      el.removeAttribute('aria-live');
                    }, 2000);
                  }
                  function startPmListObserver() {
                    const container = document.getElementById('payment_methods_list');
                    if (!container) return;
                    // run once immediately in case stream already rendered
                    highlightNewDefault();
                    pmListObserver = new MutationObserver(function() { highlightNewDefault(); });
                    pmListObserver.observe(container, { childList: true, subtree: true });
                  }
                  function stopPmListObserver() {
                    if (pmListObserver) { pmListObserver.disconnect(); pmListObserver = null; }
                    if (highlightTimer) { clearTimeout(highlightTimer); highlightTimer = null; }
                  }
                  document.addEventListener('turbo:load', startPmListObserver);
                  document.addEventListener('turbo:before-cache', stopPmListObserver);
                })();
              </script>
              <style>
                .flash-highlight {
                  animation: flashBg 2s ease-in-out;
                  box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.25);
                }
                @keyframes flashBg {
                  0% { background-color: #fffbe6; }
                  100% { background-color: transparent; }
                }
              </style>
            <% else %>
              <div class="alert alert-warning">Stripe publishable key is not configured.</div>
            <% end %>
          <% else %>
            <div class="alert alert-info">
              Card management is only available for Stripe accounts. If you are using Paddle, please use the Paddle customer portal.
            </div>
          <% end %>
        </div>
      </div>

      <% if current_user.payment_processor.processor.to_s == 'paddle' && ENV['PADDLE_CUSTOMER_PORTAL_URL'].present? %>
        <div class="alert alert-info mt-3">
          <a href="<%= ENV['PADDLE_CUSTOMER_PORTAL_URL'] %>" class="btn btn-outline-primary" target="_blank" rel="noopener">Open Paddle Portal</a>
        </div>
      <% end %>
    </div>
  </div>
</div>
