<div class="container py-5">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card shadow">
        <div class="card-header bg-white py-3">
          <h2 class="mb-0">Billing & Payment Methods</h2>
        </div>
        
        <div class="card-body">
          <% if current_user.payment_processor %>
            <h3 class="mb-4">Your Payment Methods</h3>
            
            <% if current_user.payment_processor.payment_methods.any? %>
              <div class="list-group mb-4">
                <% current_user.payment_processor.payment_methods.each do |payment_method| %>
                  <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <% if payment_method.card? %>
                        <i class="bi bi-credit-card me-2"></i>
                        <%= payment_method.brand.titleize %> ending in <%= payment_method.last4 %>
                        <small class="text-muted">
                          Expires <%= payment_method.exp_month %>/<%= payment_method.exp_year %>
                        </small>
                      <% else %>
                        <i class="bi bi-wallet me-2"></i>
                        <%= payment_method.type.titleize %>
                      <% end %>
                      
                      <% if payment_method.default? %>
                        <span class="badge bg-primary ms-2">Default</span>
                      <% end %>
                    </div>
                    
                    <div>
                      <% unless payment_method.default? %>
                        <%= button_to "Make Default", payment_method_path(payment_method, default: true), method: :patch, class: "btn btn-sm btn-outline-primary me-2" %>
                      <% end %>
                      <%= button_to "Remove", payment_method_path(payment_method), method: :delete, class: "btn btn-sm btn-outline-danger", data: { turbo_confirm: "Are you sure you want to remove this payment method?" } %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="alert alert-info">
                You don't have any payment methods yet.
              </div>
            <% end %>
            
            <div class="mb-4">
              <%= link_to "Add Payment Method", "#", class: "btn btn-primary add-payment-method-btn" %>
            </div>
            
            <hr class="my-4">
          <% end %>
          
          <h3 class="mb-4">Billing Address</h3>
          
          <%= form_with model: current_user, url: update_billing_address_subscriptions_path, method: :patch, class: "needs-validation", novalidate: true do |f| %>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <%= f.text_field :billing_name, class: "form-control", placeholder: "Full Name", required: true %>
                  <%= f.label :billing_name, "Full Name" %>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <%= f.email_field :billing_email, class: "form-control", placeholder: "Email", required: true %>
                  <%= f.label :billing_email, "Email" %>
                </div>
              </div>
              
              <div class="col-12">
                <div class="form-floating mb-3">
                  <%= f.text_field :billing_address, class: "form-control", placeholder: "Address", required: true %>
                  <%= f.label :billing_address, "Address" %>
                </div>
              </div>
              
              <div class="col-md-5">
                <div class="form-floating mb-3">
                  <%= f.text_field :billing_city, class: "form-control", placeholder: "City", required: true %>
                  <%= f.label :billing_city, "City" %>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="form-floating mb-3">
                  <%= f.text_field :billing_state, class: "form-control", placeholder: "State", required: true %>
                  <%= f.label :billing_state, "State/Province" %>
                </div>
              </div>
              
              <div class="col-md-3">
                <div class="form-floating mb-3">
                  <%= f.text_field :billing_zip, class: "form-control", placeholder: "Zip", required: true %>
                  <%= f.label :billing_zip, "Zip/Postal Code" %>
                </div>
              </div>
              
              <div class="col-12">
                <div class="form-floating mb-3">
                  <%= f.text_field :billing_country, class: "form-control", placeholder: "Country", required: true %>
                  <%= f.label :billing_country, "Country" %>
                </div>
              </div>
            </div>
            
            <div class="mt-4">
              <%= f.submit "Update Billing Address", class: "btn btn-primary" %>
            </div>
          <% end %>
          
          <% if current_user.subscribed? %>
            <hr class="my-4">
            
            <h3 class="mb-4">Current Subscription</h3>
            <div class="card mb-4">
              <div class="card-body">
                <h5 class="card-title"><%= current_user.subscription_name %></h5>
                <p class="card-text">
                  Status: <span class="badge bg-<%= current_user.subscription.active? ? 'success' : 'danger' %>">
                    <%= current_user.subscription.status.titleize %>
                  </span>
                </p>
                
                <% if current_user.subscription.active? %>
                  <p class="card-text">
                    Next billing date: <%= current_user.subscription.ends_at&.strftime('%B %d, %Y') || 'N/A' %>
                  </p>
                  
                  <%= link_to "Cancel Subscription", subscription_path(current_user.subscription), 
                      method: :delete, 
                      class: "btn btn-outline-danger",
                      data: { turbo_confirm: "Are you sure you want to cancel your subscription?" } %>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <hr class="my-4">
          
          <h3 class="mb-4">Billing History</h3>
          
          <% if current_user.payment_processor&.charges&.any? %>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Receipt</th>
                  </tr>
                </thead>
                <tbody>
                  <% current_user.payment_processor.charges.each do |charge| %>
                    <tr>
                      <td><%= charge.created_at.strftime('%B %d, %Y') %></td>
                      <td><%= number_to_currency(charge.amount / 100.0) %></td>
                      <td>
                        <% if charge.respond_to?(:description) && charge.description.present? %>
                          <%= charge.description %>
                        <% elsif charge.respond_to?(:metadata) && charge.metadata.present? && charge.metadata['description'].present? %>
                          <%= charge.metadata['description'] %>
                        <% else %>
                          <%= charge.id.present? ? "Charge #{charge.id.split('_').last}" : "Payment" %>
                        <% end %>
                      </td>
                      <td>
                        <% if charge.respond_to?(:refunded?) %>
                          <span class="badge bg-<%= charge.refunded? ? 'warning' : (charge.respond_to?(:paid?) && charge.paid? ? 'success' : 'danger') %>">
                            <%= charge.refunded? ? 'Refunded' : (charge.respond_to?(:paid?) && charge.paid? ? 'Paid' : 'Failed') %>
                          </span>
                        <% else %>
                          <span class="badge bg-secondary">Unknown</span>
                        <% end %>
                      </td>
                      <td>
                        <% if charge.respond_to?(:receipt_url) && charge.receipt_url.present? %>
                          <%= link_to "View Receipt", charge.receipt_url, target: "_blank", class: "btn btn-sm btn-outline-secondary" %>
                        <% else %>
                          N/A
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="alert alert-info">
              You don't have any billing history yet.
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="payment-method-modal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Payment Method</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="card-element" class="form-control p-3 mb-3">
          <!-- Stripe Elements will be inserted here -->
        </div>
        <div id="card-errors" class="text-danger mb-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-payment-method">Save Payment Method</button>
      </div>
    </div>
  </div>
</div>

<%= content_for :head do %>
  <script src="https://js.stripe.com/v3/"></script>
<% end %>

<%= content_for :javascript do %>
  <script>
    // Initialize Stripe outside of any event handlers to ensure it's always available
    const stripe = Stripe('<%= Rails.application.credentials.dig(:stripe, :test, :public_key) %>');
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    let cardMounted = false;
    
    // Function to initialize the modal
    function initializePaymentModal() {
      const modalElement = document.getElementById('payment-method-modal');
      if (!modalElement) return;
      
      // Initialize the Bootstrap modal
      const paymentMethodModal = new bootstrap.Modal(modalElement);
      
      // Add event listener for when the modal is shown
      modalElement.addEventListener('shown.bs.modal', function() {
        if (!cardMounted) {
          cardElement.mount('#card-element');
          cardMounted = true;
        } else {
          cardElement.clear();
        }
      });
      
      // Add event listener for the "Add Payment Method" button
      const addPaymentMethodBtn = document.querySelector('.add-payment-method-btn');
      if (addPaymentMethodBtn) {
        addPaymentMethodBtn.addEventListener('click', function(e) {
          e.preventDefault();
          paymentMethodModal.show();
        });
      }
      
      // Add event listener for the "Save Payment Method" button
      const savePaymentMethodBtn = document.getElementById('save-payment-method');
      const cardErrors = document.getElementById('card-errors');
      
      if (savePaymentMethodBtn) {
        savePaymentMethodBtn.addEventListener('click', async function() {
          savePaymentMethodBtn.disabled = true;
          savePaymentMethodBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
          
          try {
            const result = await stripe.createPaymentMethod({
              type: 'card',
              card: cardElement,
              billing_details: {
                name: '<%= current_user.billing_name || current_user.name || current_user.email %>',
                email: '<%= current_user.billing_email || current_user.email %>'
              }
            });
            
            if (result.error) {
              cardErrors.textContent = result.error.message;
              savePaymentMethodBtn.disabled = false;
              savePaymentMethodBtn.innerHTML = 'Save Payment Method';
            } else {
              // Create a form to submit the payment method ID
              const form = document.createElement('form');
              form.method = 'POST';
              form.action = '<%= payment_methods_path %>';
              
              // Add CSRF token
              const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
              const csrfInput = document.createElement('input');
              csrfInput.type = 'hidden';
              csrfInput.name = 'authenticity_token';
              csrfInput.value = csrfToken;
              
              // Add payment method ID
              const methodInput = document.createElement('input');
              methodInput.type = 'hidden';
              methodInput.name = 'payment_method_id';
              methodInput.value = result.paymentMethod.id;
              
              // Submit the form
              form.appendChild(csrfInput);
              form.appendChild(methodInput);
              document.body.appendChild(form);
              form.submit();
            }
          } catch (error) {
            console.error('Error:', error);
            cardErrors.textContent = error.message || 'An error occurred while processing your payment method.';
            savePaymentMethodBtn.disabled = false;
            savePaymentMethodBtn.innerHTML = 'Save Payment Method';
          }
        });
      }
    }
    
    // Initialize the modal when the DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializePaymentModal);
    } else {
      initializePaymentModal();
    }
    
    // Also initialize when Turbo navigates to the page
    document.addEventListener('turbo:load', initializePaymentModal);
  </script>
<% end %> 