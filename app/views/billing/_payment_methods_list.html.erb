<% if payment_methods.any? %>
  <ul class="list-group">
    <% payment_methods.each do |pm| %>
      <% brand = pm.try(:brand)&.upcase || pm.payment_method_type %>
      <% last4 = pm.try(:last4) %>
      <% modal_id = "delete-pm-#{pm.id}-modal" %>
      <% is_default = (defined?(current_default_id) && current_default_id.present?) ? (pm.id == current_default_id) : pm.default? %>

      <li class="list-group-item d-flex justify-content-between align-items-center m-2" id="<%= dom_id(pm) %>" data-defaulted="<%= (defined?(just_default_id) && just_default_id.present? && pm.id == just_default_id) ? '1' : '0' %>">
        <div class="d-flex align-items-center">
          <div>
            <strong><%= brand %></strong>
            <% if last4.present? %>
              <span class="text-muted">•••• <%= last4 %></span>
            <% end %>
            <% if is_default %>
              <span class="badge bg-success ms-2" aria-label="Default payment method">Default</span>
            <% end %>
          </div>
        </div>
        <div class="btn-group">
          <% if !is_default %>
            <%= button_to "Make default", billing_set_default_payment_method_path(pm), method: :post, form: { data: { turbo: true } }, class: "btn btn-sm btn-outline-primary" %>
          <% else %>
            <button class="btn btn-sm btn-outline-secondary" disabled aria-disabled="true" aria-label="Default payment method">Default</button>
          <% end %>
          <button type="button" class="btn btn-sm btn-outline-danger ms-2" data-bs-toggle="modal" data-bs-target="#<%= modal_id %>">
            Remove
          </button>
        </div>
      </li>

      <!-- Delete Confirmation Modal -->
      <div class="modal fade" id="<%= modal_id %>" tabindex="-1" aria-labelledby="<%= modal_id %>-label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
            	<h5 class="modal-title" id="<%= modal_id %>-label">Remove payment method</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="mb-0">Are you sure you want to remove this payment method (<strong><%= brand %></strong><% if last4.present? %> •••• <%= last4 %><% end %>)? You can add it again later.</p>
            </div>
            <div class="modal-footer">
            	<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <%= button_to "Remove", billing_detach_payment_method_path(pm), method: :delete, form: { data: { turbo: true } }, class: "btn btn-danger", data: { bs_dismiss: "modal" } %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </ul>
<% else %>
  <p class="text-muted mb-0">No saved payment methods.</p>
<% end %>
