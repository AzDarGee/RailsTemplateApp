<div class="container py-4">
  <%= turbo_stream_from billing_stream_name %>
  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Subscription Status</span>
          <%= link_to "Manage", billing_subscriptions_path, class: "btn btn-sm btn-outline-primary" %>
        </div>
        <div class="card-body">
          <% if @subscriptions.present? %>
            <% @subscriptions.first(1).each do |sub| %>
              <p class="mb-1"><strong>Name:</strong> <%= sub.name %></p>
              <p class="mb-1"><strong>Status:</strong> <span class="badge <%= sub.active? ? 'bg-success' : 'bg-secondary' %>"><%= sub.status %></span></p>
              <% if sub.current_period_end %>
                <p class="mb-0"><strong>Renews:</strong> <%= l(sub.current_period_end, format: :long) %></p>
              <% end %>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">No active subscriptions.</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Default Payment Method</span>
          <%= link_to "Manage", billing_payment_methods_path, class: "btn btn-sm btn-outline-primary" %>
        </div>
        <div class="card-body">
          <div id="default_payment_method_card">
            <%= render partial: "billing/default_payment_method_card", locals: { default_payment_method: @default_payment_method } %>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Your Subscriptions</span>
          <%= link_to "View all", billing_subscriptions_path, class: "btn btn-sm btn-outline-primary" %>
        </div>
        <div class="card-body">
          <% if @subscriptions.present? %>
            <div id="subscriptions_list">
              <%= render partial: "billing/subscriptions_list", locals: { subscriptions: @subscriptions.first(5) } %>
            </div>
          <% else %>
            <p class="text-muted mb-0">No subscriptions.</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Recent Charges</span>
          <%= link_to "View all", billing_charges_path, class: "btn btn-sm btn-outline-secondary" %>
        </div>
        <div class="card-body">
          <% if @charges.present? %>
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                <% @charges.each do |c| %>
                  <tr>
                    <td><%= l(c.created_at, format: :long) %></td>
                    <td><%= number_to_currency(c.amount.to_i / 100.0) %> <span class="text-uppercase small text-muted"><%= c.currency %></span></td>
                    <% refunded = c.respond_to?(:refunded?) ? c.refunded? : (c.amount_refunded.to_i > 0) %>
                    <td><span class="badge <%= refunded ? 'bg-warning' : 'bg-success' %>"><%= refunded ? 'refunded' : 'paid' %></span></td>
                    <td class="text-end"><%= link_to 'Receipt', billing_receipt_path(c), class: 'btn btn-sm btn-outline-secondary' %></td>
                  </tr>
                <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted mb-0">No recent charges.</p>
          <% end %>
        </div>
      </div>
    </div>

    <% if current_user.payment_processor&.processor.to_s == 'paddle' && ENV['PADDLE_CUSTOMER_PORTAL_URL'].present? %>
      <div class="col-12">
        <div class="alert alert-info d-flex justify-content-between align-items-center">
          <div>
            Manage your billing details and invoices through our Paddle customer portal.
          </div>
          <a href="<%= ENV['PADDLE_CUSTOMER_PORTAL_URL'] %>" target="_blank" rel="noopener" class="btn btn-outline-primary">Open Paddle Portal</a>
        </div>
      </div>
    <% end %>
  </div>
</div>
