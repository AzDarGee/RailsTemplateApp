<%# Remove the deleted conversation from the list %>
<%= turbo_stream.remove "conversation_#{params[:id]}" %>

<%= turbo_stream.remove "conversation_content_#{params[:id]}" %>

<%= turbo_stream.replace "messages-container" do %>
  <% conversation ||= @agent.conversations.order(updated_at: :desc).last %>
  <div  class="d-flex flex-column p-4 overflow-auto h-100" id="messages-container" 
        data-controller="chat" 
        data-chat-target="container"
        style="max-height: calc(100vh - 100px);">
    <% if conversation && conversation.messages.exists? %>
      <% conversation.messages.order(created_at: :asc).each do |message| %>
        <%= render partial: "ai/messages/message", locals: { message: message, agent: @agent } %>
      <% end %>
    <% else %>
    <div class="text-center text-muted my-5">
      <p>Select a conversation from the list</p>
        <small>Start a new conversation to begin chatting with <%= @agent.name %></small>
      </div>
    <% end %>
  </div>
<% end %>

<%# If that was the last conversation, show the empty state %>
<% if @agent.conversations.where(user: current_user).count == 0 %>
  <%= turbo_stream.replace "conversations-container" do %>
    <%= render "ai/conversations/conversations_empty", agent: @agent %>
  <% end %>
<% end %>

<%# Add a success message %>
<%= turbo_stream.replace "flash", partial: "shared/flash", locals: { type: "success", message: "Conversation deleted successfully!" } %>
